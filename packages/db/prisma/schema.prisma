generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearchPostgres", "postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pg_trgm]
}

model Event {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Required fields
  sourceUrl   String   @map("source_url")
  title       String
  city        String
  startTime   DateTime @map("start_time")

  // Optional fields
  subtitle    String?
  description String?  @db.Text
  category    EventCategory?
  organizer   String?

  // Venue information
  venueName     String?   @map("venue_name")
  address       String?
  neighborhood  String?
  lat           Float?
  lon           Float?

  // Time details
  endTime    DateTime? @map("end_time")
  timezone   String?   @default("America/New_York")

  // Pricing
  priceMin   Float?    @map("price_min")
  priceMax   Float?    @map("price_max")
  currency   String?   @default("USD")

  // Additional metadata
  minAge         Int?      @map("min_age")
  tags           String[]
  imageUrl       String?   @map("image_url")
  bookingUrl     String?   @map("booking_url")
  accessibility  String[]

  // Engagement metrics
  viewCount     Int @default(0) @map("view_count")
  viewCount24h  Int @default(0) @map("view_count_24h")
  saveCount     Int @default(0) @map("save_count")
  saveCount24h  Int @default(0) @map("save_count_24h")
  shareCount    Int @default(0) @map("share_count")
  clickCount    Int @default(0) @map("click_count")

  // Tracking
  sourceDomain   String    @map("source_domain")
  checksum       String    // Hash of content for change detection

  // Deduplication
  canonicalUrlHash String  @map("canonical_url_hash")

  // Relations
  venue    Venue?  @relation(fields: [venueId], references: [id])
  venueId  String? @map("venue_id")

  source   Source? @relation(fields: [sourceId], references: [id])
  sourceId String? @map("source_id")

  vector   EventVector?

  // Indexes
  @@unique([canonicalUrlHash, startTime], name: "unique_event")
  @@index([city, startTime])
  @@index([category, startTime])
  @@index([startTime])
  @@index([sourceDomain])
  @@index([checksum])
  @@map("events")
}

model Venue {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Core identification
  name         String
  canonicalName String  @map("canonical_name")
  normalizedName String @map("normalized_name") // Lowercase, no punctuation for matching

  // Location
  address      String?
  neighborhood String?
  city         String
  lat          Float?
  lon          Float?

  // Categorization
  primaryCategory String @map("primary_category")
  subcategories   String[] @default([])

  // Pricing & Capacity
  priceBand    VenuePriceBand? @map("price_band")
  capacity     Int?

  // Contact & Web
  website      String?
  phone        String?
  description  String?  @db.Text
  imageUrl     String?  @map("image_url")

  // Status
  isActive     Boolean  @default(true) @map("is_active")

  // Relations
  events         Event[]
  sources        VenueSource[]
  aliases        VenueAlias[]
  signals        VenueSignal[]
  heatIndex      VenueHeatIndex?

  @@unique([canonicalName, city])
  @@index([city])
  @@index([normalizedName, city])
  @@index([primaryCategory, city])
  @@index([isActive, city])
  @@map("venues")
}

enum VenuePriceBand {
  FREE
  LOW      // $, under $20
  MID      // $$, $20-50
  HIGH     // $$$, $50-100
  LUXE     // $$$$, over $100
}

model VenueSource {
  id               String   @id @default(cuid())
  venueId          String   @map("venue_id")
  venue            Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  source           VenueSourceType
  sourceExternalId String   @map("source_external_id")
  sourceUrl        String?  @map("source_url")
  rawPayload       Json     @map("raw_payload")

  confidence       Float    @default(1.0) // 0.0 to 1.0

  firstSeenAt      DateTime @default(now()) @map("first_seen_at")
  lastSeenAt       DateTime @updatedAt @map("last_seen_at")

  @@unique([source, sourceExternalId])
  @@index([venueId])
  @@index([source])
  @@map("venue_sources")
}

enum VenueSourceType {
  OSM
  FOURSQUARE
  YELP
  EVENTBRITE
  MEETUP
  FEVER
  DICE
  RA           // Resident Advisor
  NYC_DATA
  TIKTOK
  INSTAGRAM
  SNAPCHAT
  REDDIT
  OTHER
}

model VenueAlias {
  id               String   @id @default(cuid())
  venueId          String   @map("venue_id")
  venue            Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  alias            String
  aliasNormalized  String   @map("alias_normalized")
  source           String?  // Where this alias came from

  createdAt        DateTime @default(now()) @map("created_at")

  @@index([venueId])
  @@index([aliasNormalized])
  @@map("venue_aliases")
}

model VenueSignal {
  id          String   @id @default(cuid())
  venueId     String   @map("venue_id")
  venue       Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  signalType  VenueSignalType @map("signal_type")
  value       Float
  window      SignalWindow
  meta        Json?

  computedAt  DateTime @default(now()) @map("computed_at")

  @@index([venueId, signalType, window])
  @@index([computedAt])
  @@map("venue_signals")
}

enum VenueSignalType {
  EVENT_ACTIVITY      // Number of events
  SOCIAL_HEAT         // Social media mentions/engagement
  USER_TRAFFIC        // User views/interactions
  RATING              // Aggregated rating
  RISK                // Risk score (low activity, closure risk)
}

enum SignalWindow {
  HOURLY
  DAILY
  WEEKLY
  MONTHLY
}

model VenueHeatIndex {
  venueId          String   @id @map("venue_id")
  venue            Venue    @relation(fields: [venueId], references: [id], onDelete: Cascade)

  compositeScore   Float    @map("composite_score") // Overall heat 0.0-100.0
  lastComputedAt   DateTime @map("last_computed_at")

  @@index([compositeScore])
  @@map("venue_heat_index")
}

model IngestionRun {
  id          String   @id @default(cuid())
  runType     IngestionRunType @map("run_type")
  city        String

  startedAt   DateTime @default(now()) @map("started_at")
  finishedAt  DateTime? @map("finished_at")

  status      IngestionRunStatus
  statsJson   Json?    @map("stats_json") // Counts per source, dedupe stats, etc.

  errors      IngestionError[]

  @@index([city, startedAt])
  @@index([status, startedAt])
  @@map("ingestion_runs")
}

enum IngestionRunType {
  FULL
  INCREMENTAL
}

enum IngestionRunStatus {
  RUNNING
  SUCCESS
  FAILED
  PARTIAL
}

model IngestionError {
  id              String   @id @default(cuid())
  ingestionRunId  String   @map("ingestion_run_id")
  ingestionRun    IngestionRun @relation(fields: [ingestionRunId], references: [id], onDelete: Cascade)

  agentName       String   @map("agent_name")
  source          String
  message         String   @db.Text
  payload         Json?

  createdAt       DateTime @default(now()) @map("created_at")

  @@index([ingestionRunId])
  @@index([agentName])
  @@map("ingestion_errors")
}

model Source {
  id          String       @id @default(cuid())
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  name        String
  url         String       @unique
  domain      String
  city        String

  sourceType  SourceType   @map("source_type")
  category    EventCategory?

  // Crawl config
  crawlMethod CrawlMethod  @default(FIRECRAWL) @map("crawl_method")
  crawlFrequency Int       @default(3600) @map("crawl_frequency") // seconds

  active      Boolean      @default(true)
  lastCrawled DateTime?    @map("last_crawled")
  lastSuccess DateTime?    @map("last_success")

  // Selectors (optional, for targeted scraping)
  eventSelector String?    @map("event_selector")

  events      Event[]
  jobs        IngestJob[]

  @@index([domain])
  @@index([active, lastCrawled])
  @@map("sources")
}

model IngestJob {
  id         String      @id @default(cuid())
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  source     Source      @relation(fields: [sourceId], references: [id])
  sourceId   String      @map("source_id")

  status     JobStatus   @default(PENDING)

  // Execution details
  startedAt  DateTime?   @map("started_at")
  completedAt DateTime?  @map("completed_at")

  // Results
  pagesProcessed Int      @default(0) @map("pages_processed")
  eventsFound    Int      @default(0) @map("events_found")
  eventsCreated  Int      @default(0) @map("events_created")
  eventsUpdated  Int      @default(0) @map("events_updated")

  errorMessage   String?  @map("error_message") @db.Text

  // Metadata
  crawlMethod    String?  @map("crawl_method")
  metadata       Json?

  @@index([sourceId, createdAt])
  @@index([status])
  @@map("ingest_jobs")
}

model IngestionRequest {
  id           String                   @id @default(cuid())
  createdAt    DateTime                 @default(now()) @map("created_at")
  updatedAt    DateTime                 @updatedAt @map("updated_at")
  city         String
  tokens       Json?
  reason       String?
  priority     Int                      @default(0)
  status       IngestionRequestStatus   @default(PENDING)
  requestedBy  String?                  @map("requested_by")
  requesterIp  String?                  @map("requester_ip")
  requesterAgent String?                @map("requester_agent")
  startedAt    DateTime?                @map("started_at")
  processedAt  DateTime?                @map("processed_at")
  lastError    String?                  @map("last_error") @db.Text
  resultSummary Json?                   @map("result_summary")

  @@index([city, status])
  @@index([status, priority, createdAt])
  @@map("ingestion_requests")
}

enum EventCategory {
  MUSIC
  COMEDY
  THEATRE
  FITNESS
  DANCE
  ARTS
  FOOD
  NETWORKING
  FAMILY
  OTHER
}

enum SourceType {
  VENUE
  PROMOTER
  TICKETING
  MEDIA
  BLOG
  AGGREGATOR
}

enum CrawlMethod {
  FIRECRAWL
  APIFY
  MANUAL
}

enum JobStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  RETRYING
}

enum IngestionRequestStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

model SearchCache {
  id         String          @id @default(cuid())
  createdAt  DateTime        @default(now()) @map("created_at")
  updatedAt  DateTime        @updatedAt @map("updated_at")
  city       String
  query      String          @default("")
  category   EventCategory?
  timeframe  SearchTimeframe
  results    Json
  eventIds   String[]        @default([])
  generatedAt DateTime       @default(now()) @map("generated_at")
  expiresAt  DateTime        @map("expires_at")
  source     String          @default("BATCH")

  @@unique([city, timeframe, query, category], name: "unique_search_cache_key")
  @@index([timeframe, city], name: "idx_search_cache_timeframe_city")
  @@map("search_cache")
}

enum SearchTimeframe {
  TODAY
  WEEK
  MONTH
}

// ============================================
// V2 Models: Authentication & Personalization
// ============================================

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  emailVerified DateTime?     @map("email_verified")
  name          String?
  image         String?

  profile       UserProfile?
  searchSessions SearchSession[]
  accounts      Account[]
  sessions      Session[]

  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model UserProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique @map("user_id")
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Preferences
  homeCity            String?  @map("home_city")
  neighborhoods       String[]
  favoriteCategories  String[] @map("favorite_categories")
  priceMin            Float?   @map("price_min")
  priceMax            Float?   @map("price_max")
  timeOfDay           String?  @map("time_of_day") // morning/afternoon/evening/night
  minAgePref          Int?     @map("min_age_pref")

  // Activity tracking
  lastSeenAt          DateTime? @map("last_seen_at")
  searchCount         Int       @default(0) @map("search_count")

  // Metadata
  meta                Json?

  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@index([homeCity])
  @@map("user_profiles")
}

model SearchSession {
  id        String   @id @default(cuid())
  userId    String?  @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  query     String
  city      String
  filters   Json     // Category, price range, date range, etc.

  resultsCount Int    @default(0) @map("results_count")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([city, createdAt])
  @@map("search_sessions")
}

model DiscoveryLog {
  id        String   @id @default(cuid())

  city      String
  query     String
  engine    String   // 'serpapi' | 'apify' | 'firecrawl'
  url       String
  score     Float?
  accepted  Boolean  @default(false)

  eventsFound Int    @default(0) @map("events_found")
  errorMessage String? @map("error_message") @db.Text

  createdAt DateTime @default(now()) @map("created_at")

  @@index([city, createdAt])
  @@index([query, createdAt])
  @@map("discovery_logs")
}

model EventVector {
  id                String   @id @default(cuid())
  eventId           String   @unique @map("event_id")
  event             Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  qdrantId          String   @unique @map("qdrant_id") // UUID in Qdrant
  embeddingVersion  String   @map("embedding_version") // e.g., "bge-m3-v1"
  lastEmbeddedAt    DateTime @map("last_embedded_at")

  createdAt         DateTime @default(now()) @map("created_at")

  @@index([embeddingVersion])
  @@map("event_vectors")
}

// ============================================
// V3 Models: Ranking, Analytics, Ads
// ============================================

model RankingWeights {
  id        String   @id @default(cuid())
  version   Int      @default(1)
  weights   Json     // Per-feature weights for scoring
  metrics   Json?    // Training metrics (accuracy, eCTR, etc.)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([version])
  @@map("ranking_weights")
}

model AnalyticsEvent {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  sessionId    String   @map("session_id")
  eventId      String?  @map("event_id")
  adCampaignId String?  @map("ad_campaign_id")
  adCreativeId String?  @map("ad_creative_id")

  type         AnalyticsEventType
  props        Json     // Additional properties (slot, query, rank, etc.)

  city         String?
  deviceType   String?  @map("device_type") // mobile|tablet|desktop

  occurredAt   DateTime @default(now()) @map("occurred_at")

  @@index([userId, occurredAt])
  @@index([sessionId, occurredAt])
  @@index([eventId, type, occurredAt])
  @@index([adCampaignId, type, occurredAt])
  @@index([type, occurredAt])
  @@index([city, occurredAt])
  @@map("analytics_events")
}

enum AnalyticsEventType {
  IMPRESSION
  VIEW
  EXPAND
  SAVE
  SHARE
  OUTBOUND_CLICK
  BOOK_CLICK
  DISMISS
  HIDE_VENUE
  HIDE_CATEGORY
  REPORT
  AD_IMPRESSION
  AD_CLICK
  AD_VIEWABLE
  AD_CONVERSION
  SEARCH
  FILTER_CHANGE
  WEB_VITAL
}

model UserConsent {
  id            String   @id @default(cuid())
  userId        String?  @map("user_id")
  sessionId     String   @map("session_id")

  analytics     Boolean  @default(false)
  personalization Boolean @default(false)
  advertising   Boolean  @default(false)

  ipAddress     String?  @map("ip_address")
  userAgent     String?  @map("user_agent") @db.Text

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@unique([sessionId])
  @@index([userId])
  @@map("user_consents")
}

model UserInteraction {
  id              String   @id @default(cuid())
  userId          String?  @map("user_id")
  sessionId       String   @map("session_id")
  eventId         String   @map("event_id")

  saved           Boolean  @default(false)
  shared          Boolean  @default(false)
  bookmarked      Boolean  @default(false)
  dismissed       Boolean  @default(false)

  viewDuration    Int?     @map("view_duration") // seconds
  expandedDetails Boolean  @default(false) @map("expanded_details")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@unique([sessionId, eventId])
  @@index([userId, eventId])
  @@index([eventId])
  @@map("user_interactions")
}

model UserBlocklist {
  id           String   @id @default(cuid())
  userId       String?  @map("user_id")
  sessionId    String   @map("session_id")

  venueId      String?  @map("venue_id")
  venueName    String?  @map("venue_name")
  category     String?

  reason       String?  @db.Text

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([sessionId])
  @@index([venueId])
  @@map("user_blocklists")
}

// ============================================
// Ad Platform Models
// ============================================

model AdCampaign {
  id          String   @id @default(cuid())
  name        String
  advertiser  String

  status      AdCampaignStatus @default(ACTIVE)

  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")

  dailyBudget Float    @map("daily_budget")
  totalBudget Float    @map("total_budget")

  pacing      AdPacing @default(EVEN)

  qualityScore Float?  @default(1.0) @map("quality_score") // 0.0-1.0

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  creatives   AdCreative[]
  targetings  AdTargeting[]
  budgets     AdBudget[]
  impressions AdImpression[]
  conversions AdConversion[]

  @@index([status, startDate, endDate])
  @@index([advertiser])
  @@map("ad_campaigns")
}

enum AdCampaignStatus {
  ACTIVE
  PAUSED
  ENDED
  REJECTED
  PENDING_REVIEW
}

enum AdPacing {
  EVEN
  ASAP
}

model AdCreative {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")
  campaign    AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  kind        AdCreativeKind

  title       String
  body        String?  @db.Text
  imageUrl    String?  @map("image_url")
  clickUrl    String   @map("click_url")

  eventId     String?  @map("event_id") // For house event promos

  status      AdCreativeStatus @default(ACTIVE)
  policyNotes String?  @map("policy_notes") @db.Text

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  impressions AdImpression[]

  @@index([campaignId, status])
  @@index([status])
  @@map("ad_creatives")
}

enum AdCreativeKind {
  DISPLAY
  NATIVE
  HOUSE_EVENT
  SPONSORED_COLLECTION
}

enum AdCreativeStatus {
  ACTIVE
  PAUSED
  REJECTED
  PENDING_REVIEW
}

model AdTargeting {
  id            String   @id @default(cuid())
  campaignId    String   @map("campaign_id")
  campaign      AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  cities        String[]
  neighborhoods String[]
  categories    String[]

  priceMin      Float?   @map("price_min")
  priceMax      Float?   @map("price_max")

  timesOfDay    String[] @map("times_of_day") // morning, afternoon, evening, late
  daysOfWeek    String[] @map("days_of_week") // mon, tue, wed, ...

  keywords      String[]
  excludeVenues String[] @map("exclude_venues")
  includeVenues String[] @map("include_venues")

  ageMin        Int?     @map("age_min")
  ageMax        Int?     @map("age_max")

  createdAt     DateTime @default(now()) @map("created_at")

  @@index([campaignId])
  @@map("ad_targetings")
}

model AdBudget {
  id          String   @id @default(cuid())
  campaignId  String   @unique @map("campaign_id")
  campaign    AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  spent       Float    @default(0)
  impressions Int      @default(0)
  clicks      Int      @default(0)
  viewable    Int      @default(0)
  conversions Int      @default(0)

  todaySpent  Float    @default(0) @map("today_spent")
  todayDate   DateTime? @map("today_date")

  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("ad_budgets")
}

model AdImpression {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")
  campaign    AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  creativeId  String   @map("creative_id")
  creative    AdCreative @relation(fields: [creativeId], references: [id], onDelete: Cascade)

  sessionId   String   @map("session_id")
  userId      String?  @map("user_id")

  slot        AdSlot

  city        String?
  query       String?

  viewable    Boolean  @default(false) // 50% in viewport for â‰¥1s
  viewedAt    DateTime? @map("viewed_at")

  occurredAt  DateTime @default(now()) @map("occurred_at")

  clicks      AdClick[]
  conversions AdConversion[]

  @@index([campaignId, occurredAt])
  @@index([creativeId, occurredAt])
  @@index([sessionId, occurredAt])
  @@index([slot, occurredAt])
  @@map("ad_impressions")
}

enum AdSlot {
  FEED_P3
  FEED_P10
  FEED_END
  MAP_PIN
  DETAIL_SIDEBAR
  SEARCH_INTERSTITIAL
  HEADER_BANNER
}

model AdClick {
  id           String   @id @default(cuid())
  impressionId String   @map("impression_id")
  impression   AdImpression @relation(fields: [impressionId], references: [id], onDelete: Cascade)

  occurredAt   DateTime @default(now()) @map("occurred_at")

  @@index([impressionId])
  @@map("ad_clicks")
}

model AdConversion {
  id           String   @id @default(cuid())
  campaignId   String   @map("campaign_id")
  campaign     AdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  impressionId String?  @map("impression_id")
  impression   AdImpression? @relation(fields: [impressionId], references: [id], onDelete: SetNull)

  clickId      String?  @map("click_id")
  eventId      String?  @map("event_id")

  type         AdConversionType
  value        Float?   // Revenue value if applicable

  occurredAt   DateTime @default(now()) @map("occurred_at")

  @@index([campaignId, occurredAt])
  @@index([impressionId])
  @@index([eventId])
  @@map("ad_conversions")
}

enum AdConversionType {
  BOOK_CLICK
  OUTBOUND_CLICK
  SAVE
  SHARE
}

model AdFrequencyCap {
  id          String   @id @default(cuid())
  campaignId  String   @map("campaign_id")
  sessionId   String   @map("session_id")

  count       Int      @default(0)

  lastShownAt DateTime @map("last_shown_at")
  resetsAt    DateTime @map("resets_at")

  @@unique([campaignId, sessionId])
  @@index([campaignId, resetsAt])
  @@map("ad_frequency_caps")
}

model AdPolicy {
  id          String   @id @default(cuid())
  creativeId  String   @map("creative_id")

  reviewedBy  String?  @map("reviewed_by")
  status      AdPolicyStatus

  rejectionReason String? @map("rejection_reason") @db.Text
  notes       String?  @db.Text

  reviewedAt  DateTime? @map("reviewed_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([creativeId])
  @@index([status])
  @@map("ad_policies")
}

enum AdPolicyStatus {
  PENDING
  APPROVED
  REJECTED
  FLAGGED
}

// ============================================
// Learning System Models
// ============================================

model ModelVersion {
  id        String   @id @default(cuid())
  name      String   // e.g., "ranker_v1", "taste_vector_v2", "slate_bandit_v1"
  type      ModelType
  version   String   // Semantic version (e.g., "1.0.0")
  config    Json?    // Model-specific configuration
  createdAt DateTime @default(now()) @map("created_at")

  rankerSnapshots RankerSnapshot[]

  @@index([name, version])
  @@index([type])
  @@map("model_versions")
}

enum ModelType {
  LLM
  RANKER
  BANDIT
  EMBEDDING
  TASTE_VECTOR
}

model EventLog {
  id          String   @id @default(cuid())
  userId      String?  @map("user_id")
  anonId      String?  @map("anon_id")
  sessionId   String   @map("session_id")
  traceId     String   @map("trace_id")
  eventType   EventLogType @map("event_type")
  payload     Json     // Flexible payload for different event types
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([sessionId, createdAt])
  @@index([traceId])
  @@index([eventType, createdAt])
  @@index([createdAt])
  @@map("event_logs")
}

enum EventLogType {
  QUERY
  SLATE_IMPRESSION
  CARD_VIEW
  CLICK_ROUTE
  CLICK_BOOK
  SAVE
  HIDE
  REASK
  ERROR
  FEEDBACK_POSITIVE
  FEEDBACK_NEGATIVE
}

model TasteVector {
  id        String   @id @default(cuid())
  userId    String   @unique @map("user_id")
  vector    Json     // JSON array of floats [0.1, 0.2, ...]
  dimension Int      @default(768) // Embedding dimension
  version   String   @default("bge-m3-v1") // Embedding version
  metadata  Json?    // Additional metadata (decay rate, update count, etc.)
  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([version])
  @@map("taste_vectors")
}

model SlatePolicy {
  id        String   @id @default(cuid())
  name      String   @unique // e.g., "80safe-20novel", "epsilon-greedy-0.15"
  params    Json     // Policy-specific parameters
  isActive  Boolean  @default(false) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@map("slate_policies")
}

model RankerSnapshot {
  id             String   @id @default(cuid())
  modelVersionId String   @map("model_version_id")
  modelVersion   ModelVersion @relation(fields: [modelVersionId], references: [id], onDelete: Cascade)

  weights        Json     // Feature weights
  metricsJson    Json?    @map("metrics_json") // NDCG, CTR uplift, etc.
  trainingStats  Json?    @map("training_stats") // Training metadata
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([modelVersionId])
  @@index([createdAt])
  @@map("ranker_snapshots")
}
